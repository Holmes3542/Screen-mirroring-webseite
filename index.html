<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¥ MyVideoShop</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #1a1a2e; color: white; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        nav { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        .nav-tabs { display: flex; gap: 10px; }
        .tab-btn { padding: 10px 20px; background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 5px; cursor: pointer; }
        .tab-btn.active { background: #4CAF50; }
        .section { display: none; }
        .section.active { display: block; }
        .video-container { background: black; border-radius: 10px; overflow: hidden; margin: 20px 0; }
        video { width: 100%; max-height: 400px; }
        .controls { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px; margin: 20px 0; }
        input, button { padding: 10px; margin: 5px; border-radius: 5px; }
        input { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; width: 300px; }
        button { background: #2196F3; color: white; border: none; cursor: pointer; }
        button:disabled { background: #666; cursor: not-allowed; }
        .status { padding: 5px 10px; border-radius: 3px; margin: 5px; display: inline-block; }
        .status.online { background: #4CAF50; }
        .status.offline { background: #f44336; }
        .status.streaming { background: #ff9800; }
    </style>
</head>
<body>
    <div class="container">
        <nav>
            <div class="nav-tabs">
                <button class="tab-btn active" onclick="showSection('home')">ğŸ  Home</button>
                <button class="tab-btn" onclick="showSection('broadcast')">ğŸ¬ Streamen</button>
                <button class="tab-btn" onclick="showSection('watch')">ğŸ‘ï¸ Zuschauen</button>
            </div>
        </nav>

        <!-- Home Section -->
        <section id="home" class="section active">
            <h1>ğŸ¥ MyVideoShop</h1>
            <p>Einfache Streaming-App mit Ton-Fix</p>
            <div class="controls">
                <button onclick="showSection('broadcast')" style="background: #f44336;">ğŸ¬ Stream starten</button>
                <button onclick="showSection('watch')" style="background: #4CAF50;">ğŸ‘ï¸ Stream ansehen</button>
            </div>
            <p><strong>âš¡ Ton-Fix:</strong> Ton wird immer Ã¼bertragen, auch wenn das Streaming-GerÃ¤t stumm ist!</p>
        </section>

        <!-- Broadcast Section -->
        <section id="broadcast" class="section">
            <h2>ğŸ¬ Streamen</h2>
            <div class="controls">
                <div>
                    <label>Stream-Typ:</label><br>
                    <button onclick="setStreamType('camera')" id="btnCamera">ğŸ“¹ Kamera</button>
                    <button onclick="setStreamType('screen')" id="btnScreen">ğŸ–¥ï¸ Bildschirm</button>
                </div>
                <div>
                    <label>Stream ID:</label><br>
                    <input type="text" id="streamId" readonly>
                    <button onclick="copyStreamId()">ğŸ“‹ Kopieren</button>
                </div>
                <div>
                    <button id="btnStart" onclick="startStreaming()">â–¶ï¸ Start Stream</button>
                    <button id="btnStop" onclick="stopStreaming()" disabled>â¹ï¸ Stop Stream</button>
                </div>
                <div>
                    <label><input type="checkbox" id="enableAudio" checked> ğŸ”Š Ton aktivieren</label>
                </div>
                <div>
                    <span class="status offline" id="streamStatus">Offline</span>
                    <span>Zuschauer: <span id="viewerCount">0</span></span>
                </div>
            </div>
            <div class="video-container">
                <video id="localVideo" muted autoplay playsinline></video>
            </div>
        </section>

        <!-- Watch Section -->
        <section id="watch" class="section">
            <h2>ğŸ‘ï¸ Zuschauen</h2>
            <div class="controls">
                <div>
                    <label>Stream ID:</label><br>
                    <input type="text" id="inputStreamId" placeholder="Stream-ID hier eingeben">
                    <button id="btnConnect" onclick="connectToStream()">ğŸ”— Verbinden</button>
                    <button id="btnDisconnect" onclick="disconnectFromStream()" disabled>âœ–ï¸ Trennen</button>
                </div>
                <div>
                    <button onclick="loadStreams()" style="background: #9C27B0;">ğŸ“¡ Aktive Streams laden</button>
                </div>
                <div id="streamsList"></div>
                <div>
                    <span class="status offline" id="connectionStatus">Nicht verbunden</span>
                    <button onclick="forceUnmute()" style="background: #FF9800;">ğŸ”Š Ton erzwingen</button>
                </div>
            </div>
            <div class="video-container">
                <video id="remoteVideo" autoplay playsinline controls></video>
            </div>
        </section>
    </div>

    <script>
        // Globale Variablen
        let socket = null;
        let localStream = null;
        let remoteStream = null;
        let peerConnections = new Map();
        let currentStreamId = null;
        let isBroadcasting = false;
        let isWatching = false;
        let viewerCount = 0;
        let streamType = 'camera';

        // Socket.io initialisieren
        function initSocket() {
            socket = io();
            
            socket.on('connect', () => {
                console.log('âœ… Verbunden mit Server');
                generateStreamId();
            });
            
            socket.on('stream-started', (data) => {
                console.log('Stream gestartet:', data.streamId);
                document.getElementById('streamStatus').className = 'status streaming';
                document.getElementById('streamStatus').textContent = 'Live';
            });
            
            socket.on('viewer-joined', (data) => {
                console.log('Neuer Viewer:', data.viewerId);
                viewerCount++;
                document.getElementById('viewerCount').textContent = viewerCount;
                createPeerConnection(data.viewerId, true);
            });
            
            socket.on('stream-joined', (data) => {
                console.log('Stream beigetreten:', data.streamId);
                document.getElementById('connectionStatus').className = 'status streaming';
                document.getElementById('connectionStatus').textContent = 'Verbunden';
            });
            
            socket.on('webrtc-signal', async (data) => {
                if (data.type === 'offer') {
                    await createPeerConnection(data.from, false);
                    const peer = peerConnections.get(data.from);
                    if (peer) peer.signal(data.signal);
                } else if (data.type === 'answer') {
                    const peer = peerConnections.get(data.from);
                    if (peer) peer.signal(data.signal);
                }
            });
            
            socket.on('active-streams', (streams) => {
                updateStreamsList(streams);
            });
            
            socket.on('stream-ended', () => {
                alert('Stream wurde beendet');
                disconnectFromStream();
            });
        }

        // Stream starten
        async function startStreaming() {
            try {
                const enableAudio = document.getElementById('enableAudio').checked;
                
                if (streamType === 'screen') {
                    localStream = await navigator.mediaDevices.getDisplayMedia({
                        video: true,
                        audio: enableAudio
                    });
                } else {
                    localStream = await navigator.mediaDevices.getUserMedia({
                        video: true,
                        audio: enableAudio
                    });
                }
                
                // Ton erzwingen
                forceAudioUnmute(localStream);
                
                document.getElementById('localVideo').srcObject = localStream;
                document.getElementById('btnStart').disabled = true;
                document.getElementById('btnStop').disabled = false;
                
                socket.emit('start-stream', currentStreamId);
                isBroadcasting = true;
                
            } catch (error) {
                alert('Fehler: ' + error.message);
            }
        }

        // Stream stoppen
        function stopStreaming() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            document.getElementById('localVideo').srcObject = null;
            document.getElementById('btnStart').disabled = false;
            document.getElementById('btnStop').disabled = true;
            document.getElementById('streamStatus').className = 'status offline';
            document.getElementById('streamStatus').textContent = 'Offline';
            socket.emit('stop-stream', currentStreamId);
            isBroadcasting = false;
        }

        // Mit Stream verbinden
        function connectToStream() {
            const streamId = document.getElementById('inputStreamId').value;
            if (!streamId) return alert('Bitte Stream-ID eingeben');
            
            socket.emit('join-stream', streamId);
            document.getElementById('btnConnect').disabled = true;
            document.getElementById('btnDisconnect').disabled = false;
            isWatching = true;
        }

        // Verbindung trennen
        function disconnectFromStream() {
            if (remoteStream) {
                remoteStream.getTracks().forEach(track => track.stop());
            }
            document.getElementById('remoteVideo').srcObject = null;
            document.getElementById('btnConnect').disabled = false;
            document.getElementById('btnDisconnect').disabled = true;
            document.getElementById('connectionStatus').className = 'status offline';
            document.getElementById('connectionStatus').textContent = 'Getrennt';
            isWatching = false;
        }

        // WebRTC Peer Connection
        function createPeerConnection(peerId, isInitiator) {
            const peer = new SimplePeer({
                initiator: isInitiator,
                trickle: true,
                stream: isInitiator ? localStream : null
            });
            
            peer.on('signal', (data) => {
                socket.emit('webrtc-signal', {
                    to: peerId,
                    signal: data,
                    type: data.type
                });
            });
            
            peer.on('stream', (stream) => {
                remoteStream = stream;
                forceRemoteAudioUnmute(stream);
                document.getElementById('remoteVideo').srcObject = stream;
            });
            
            peerConnections.set(peerId, peer);
        }

        // Ton erzwingen
        function forceAudioUnmute(stream) {
            stream.getAudioTracks().forEach(track => {
                track.enabled = true;
            });
        }

        function forceRemoteAudioUnmute(stream) {
            stream.getAudioTracks().forEach(track => {
                track.enabled = true;
            });
            document.getElementById('remoteVideo').muted = false;
            document.getElementById('remoteVideo').volume = 1.0;
        }

        function forceUnmute() {
            if (remoteStream) {
                forceRemoteAudioUnmute(remoteStream);
                alert('Ton wurde erzwungen!');
            }
        }

        // Hilfsfunktionen
        function generateStreamId() {
            currentStreamId = 'stream_' + Math.random().toString(36).substr(2, 9);
            document.getElementById('streamId').value = currentStreamId;
        }

        function copyStreamId() {
            navigator.clipboard.writeText(currentStreamId);
            alert('Stream-ID kopiert!');
        }

        function setStreamType(type) {
            streamType = type;
            document.getElementById('btnCamera').style.background = type === 'camera' ? '#4CAF50' : '';
            document.getElementById('btnScreen').style.background = type === 'screen' ? '#4CAF50' : '';
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            document.querySelector(`button[onclick*="${sectionId}"]`).classList.add('active');
        }

        function loadStreams() {
            socket.emit('get-streams');
        }

        function updateStreamsList(streams) {
            const container = document.getElementById('streamsList');
            container.innerHTML = '<h3>Aktive Streams:</h3>';
            streams.forEach(stream => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <div style="margin: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 5px;">
                        <strong>${stream.id}</strong><br>
                        ${stream.viewerCount} Zuschauer
                        <button onclick="joinStream('${stream.id}')" style="margin-left: 10px;">Beitreten</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function joinStream(streamId) {
            document.getElementById('inputStreamId').value = streamId;
            connectToStream();
        }

        // Initialisierung
        window.addEventListener('load', initSocket);
    </script>
</body>
</html>
